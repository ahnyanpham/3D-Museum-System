<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảo Tàng Hồ Chí Minh</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="/css/style.css">

    <script>
    // Define toggleSidebar IMMEDIATELY in HEAD
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const hamburger = document.getElementById('hamburgerBtn');

        if (sidebar && overlay && hamburger) {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }
    }
    </script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Bảo Tàng Hồ Chí Minh</h1>
            <p>Hệ Thống Quản Lý Tham Quan</p>
        </header>

        <!-- HAMBURGER BUTTON -->
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- SIDEBAR MENU -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="close-sidebar" onclick="toggleSidebar()">×</button>
            </div>

            <div class="sidebar-items">
                <button class="sidebar-item active" data-page="dashboard">Tổng Quan</button>
                <button class="sidebar-item" data-page="map">Bản Đồ</button>
                <button class="sidebar-item" data-page="floorplan">Sơ Đồ</button>
                <a href="/tham-quan" target="_blank" class="sidebar-item">Tham Quan</a>
                <button class="sidebar-item" data-page="tickets">Bán Vé</button>
                <button class="sidebar-item" data-page="customers">Khách Hàng</button>
                <button class="sidebar-item" data-page="checkin">Check-in</button>
                <button class="sidebar-item" data-page="checkout">Check-out</button>
                <button class="sidebar-item" data-page="history">Lịch Sử Tham Quan</button>
                
                <!-- NEW ADMIN FEATURES -->
                <button class="sidebar-item" onclick="window.location.href='/users.html'" style="border-top:2px solid rgba(255,255,255,0.1);margin-top:10px;padding-top:15px">Quản Lý User</button>
                <button class="sidebar-item" onclick="window.location.href='/orders.html'">Quản Lý Đơn Hàng</button>
                
                <!-- LOGOUT BUTTON -->
                <button class="sidebar-item logout-btn" onclick="handleLogout()" style="background:#dc3545;color:white;margin-top:auto;font-weight:600;border-top:2px solid rgba(255,255,255,0.2);">
                    Đăng Xuất
                </button>
            </div>
        </nav>

        <!-- OVERLAY -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <main class="main-content">
            <!-- DASHBOARD PAGE -->
            <div id="dashboard-page" class="page active">
                <h2 class="page-title">Tổng Quan</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Tổng Số Vé</div>
                        <div class="stat-value" id="total-tickets">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Doanh Thu</div>
                        <div class="stat-value" id="total-revenue">0 đ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Khách Hàng</div>
                        <div class="stat-value" id="total-customers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Lượt Tham Quan</div>
                        <div class="stat-value" id="total-visits">0</div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="card">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                            <span>Doanh Thu</span>
                            <div style="display:flex;gap:5px;flex-wrap:wrap">
                                <button class="time-filter-btn active" data-days="1">Hôm nay</button>
                                <button class="time-filter-btn" data-days="7">7 ngày</button>
                                <button class="time-filter-btn" data-days="30">30 ngày</button>
                                <button class="time-filter-btn" data-days="180">6 tháng</button>
                            </div>
                        </div>
                        <div class="card-body"><canvas id="revenue-chart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-header">Phân Bổ Loại Vé</div>
                        <div class="card-body"><canvas id="ticket-types-chart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- MAP PAGE - 3D EMBEDDED -->
            <div id="map-page" class="page">
                <h2 class="page-title">Bản Đồ 3D Bến Nhà Rồng</h2>
                <div style="height: calc(100vh - 220px); min-height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: #f5f5f5;">
                    <iframe
                        src="/public/3d-map/index.html"
                        style="width: 100%; height: 100%; border: none; display: block;"
                        title="Bản đồ 3D Bảo tàng Hồ Chí Minh"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>

            <!-- FLOOR PLAN PAGE - EMBEDDED (NO DOUBLE SCROLL) -->
            <div id="floorplan-page" class="page">
                <iframe
                    src="/public/floor-plans/index.html"
                    style="width: 100%; height: 2500px; border: none; display: block;"
                    title="Sơ Đồ Bảo Tàng Hồ Chí Minh"
                    scrolling="no">
                </iframe>
            </div>

            <!-- TICKETS PAGE -->
            <div id="tickets-page" class="page">
                <h2 class="page-title">Quản Lý Bán Vé</h2>
                <div class="form-grid">
                    <div class="card">
                        <div class="card-header">Thông Tin Bán Vé</div>
                        <div class="card-body">
                            <form id="ticket-form">
                                <div class="form-group">
                                    <label>Số điện thoại <span style="color:red">*</span></label>
                                    <div style="display:flex;gap:10px">
                                        <input type="text" id="customer-phone" class="form-control" placeholder="0909123456" required>
                                        <button type="button" id="search-customer" class="btn btn-primary">Tìm</button>
                                    </div>
                                    <div id="customer-info" style="margin-top:10px"></div>
                                </div>
                                <div class="form-group">
                                    <label>Loại vé <span style="color:red">*</span></label>
                                    <select id="ticket-type" class="form-control" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Số lượng <span style="color:red">*</span></label>
                                    <input type="number" id="quantity" class="form-control" min="1" value="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Ngày tham quan <span style="color:red">*</span></label>
                                    <input type="date" id="visit-date" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Thanh toán <span style="color:red">*</span></label>
                                    <select id="payment-method" class="form-control" required>
                                        <option value="Tiền mặt">Tiền mặt</option>
                                        <option value="Chuyển khoản">Chuyển khoản</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Tổng tiền</label>
                                    <div id="total-price" style="font-size:24px;font-weight:700;color:#667eea;padding:15px;background:#f0f0f0;border-radius:8px;text-align:center">0 đ</div>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width:100%">Bán vé</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            Danh Sách Vé
                            <button id="reload-tickets" class="btn btn-sm" style="float:right;background:white;color:#667eea">Làm mới</button>
                        </div>
                        <div class="card-body">
                            <div id="recent-tickets"></div>
                            <div id="tickets-pagination" style="margin-top:20px"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CUSTOMERS PAGE -->
            <div id="customers-page" class="page">
                <h2 class="page-title">Quản Lý Khách Hàng</h2>
                <div class="form-grid">
                    <div class="card">
                        <div class="card-header">Thêm Khách Hàng</div>
                        <div class="card-body">
                            <form id="customer-form">
                                <div class="form-group">
                                    <label>Họ tên <span style="color:red">*</span></label>
                                    <input type="text" name="full_name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Số điện thoại</label>
                                    <input type="tel" name="phone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" name="email" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Ngày sinh</label>
                                    <input type="date" name="date_of_birth" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Giới tính</label>
                                    <select name="gender" class="form-control">
                                        <option value="">-- Chọn --</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quốc tịch</label>
                                    <input type="text" name="nationality" class="form-control" value="Việt Nam">
                                </div>
                                <button type="submit" class="btn btn-primary" style="width:100%">Thêm</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                            <span>Danh Sách</span>
                            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                                <button id="reload-customers" class="btn btn-sm" style="background:white;color:#667eea">Làm mới</button>
                                <input type="text" id="search-customers" placeholder="Tìm..." style="width:200px;padding:5px;border:1px solid #ddd;border-radius:4px">
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="customers-list"></div>
                            <div id="customers-pagination" style="margin-top:20px"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHECKIN PAGE -->
            <div id="checkin-page" class="page">
                <h2 class="page-title">Check-in</h2>
                <div class="form-grid">
                    <div class="card">
                        <div class="card-header">Quét Mã</div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Mã vé</label>
                                <input type="text" id="checkin-ticket-code" class="form-control" placeholder="MT..." autofocus>
                            </div>
                            <button id="checkin-btn" class="btn btn-primary" style="width:100%">Check-in</button>
                            <div id="checkin-result" style="margin-top:20px"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            Vé Hoạt Động
                            <button id="reload-checkin" class="btn btn-sm" style="float:right;background:white;color:#667eea">Làm mới</button>
                        </div>
                        <div class="card-body">
                            <div id="active-tickets-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHECKOUT PAGE -->
            <div id="checkout-page" class="page">
                <h2 class="page-title">Check-out</h2>
                <div class="card">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
                        <span>Đang Tham Quan</span>
                        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                            <input type="text" id="search-checkout-customers" placeholder="Tìm tên, SĐT, mã vé..." style="width:250px;padding:8px;border:1px solid #ddd;border-radius:4px">
                            <button id="refresh-active-visits" class="btn btn-sm" style="background:white;color:#667eea">Làm mới</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="active-visits-list"></div>
                    </div>
                </div>
            </div>

            <!-- HISTORY PAGE -->
            <div id="history-page" class="page">
                <h2 class="page-title">Lịch Sử</h2>

                <div class="card">
                    <div class="card-header">Bộ Lọc</div>
                    <div class="card-body">
                        <div class="filter-grid">
                            <div class="form-group" style="margin:0">
                                <label>Check-out từ ngày</label>
                                <input type="date" id="history-date-from" class="form-control">
                            </div>
                            <div class="form-group" style="margin:0">
                                <label>Giới hạn</label>
                                <select id="history-limit" class="form-control">
                                    <option value="50">50 kết quả</option>
                                    <option value="100">100 kết quả</option>
                                    <option value="200">200 kết quả</option>
                                </select>
                            </div>
                            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                                <span style="font-weight:600;white-space:nowrap">Đánh giá:</span>
                                <button class="rating-filter-btn active" data-rating="all" style="padding:8px 15px;border:2px solid #667eea;background:#667eea;color:white;border-radius:6px;cursor:pointer;font-weight:500;font-size:13px">Tất cả</button>
                                <button class="rating-filter-btn" data-rating="1" style="padding:6px 10px;border:2px solid #fbbf24;background:white;color:#fbbf24;border-radius:6px;cursor:pointer;font-size:16px">★</button>
                                <button class="rating-filter-btn" data-rating="2" style="padding:6px 10px;border:2px solid #fbbf24;background:white;color:#fbbf24;border-radius:6px;cursor:pointer;font-size:16px">★★</button>
                                <button class="rating-filter-btn" data-rating="3" style="padding:6px 10px;border:2px solid #fbbf24;background:white;color:#fbbf24;border-radius:6px;cursor:pointer;font-size:16px">★★★</button>
                                <button class="rating-filter-btn" data-rating="4" style="padding:6px 10px;border:2px solid #fbbf24;background:white;color:#fbbf24;border-radius:6px;cursor:pointer;font-size:16px">★★★★</button>
                                <button class="rating-filter-btn" data-rating="5" style="padding:6px 10px;border:2px solid #fbbf24;background:white;color:#fbbf24;border-radius:6px;cursor:pointer;font-size:16px">★★★★★</button>
                            </div>
                            <button id="reload-history" class="btn btn-primary">Tải lại</button>
                        </div>
                    </div>
                </div>

                <div id="history-stats"></div>

                <div class="card">
                    <div class="card-header">Lịch Sử Tham Quan</div>
                    <div class="card-body">
                        <div id="history-table"></div>
                    </div>
                </div>
            </div>
        </main>

        <div id="loading" class="loading">
            <div class="spinner"></div>
        </div>

        <div id="toast" class="toast"></div>

        <div id="ticket-modal" class="modal">
            <div class="modal-content">
                <span class="close">×</span>
                <div id="ticket-details"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/dashboard.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/admin-tickets.js"></script>
    <script src="/js/customers.js"></script>
    <script src="/js/checkin.js"></script>
    <script src="/js/checkout.js"></script>
    <script src="/js/history.js"></script>
    
    <!-- LOGOUT AND AUTH CHECK -->
    <script>
    function handleLogout() {
        if (confirm('Bạn có chắc muốn đăng xuất?')) {
            // Call logout API with session cookie
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            }).finally(() => {
                // Redirect to login
                window.location.href = '/web/admin/login/';
            });
        }
    }
    
    // Check authentication on page load (using session cookies)
    window.addEventListener('load', function() {
        // Verify session validity via cookie-based auth
        fetch('/api/auth/verify', {
            credentials: 'include'  // Important: send cookies
        })
        .then(res => res.json())
        .then(data => {
            if (!data.logged_in) {
                // Session invalid, redirect to login
                console.log('Not logged in, redirecting...');
                window.location.href = '/web/admin/login/';
            } else {
                // Logged in successfully
                console.log('Logged in as:', data.data.username);
            }
        })
        .catch(error => {
            // Only redirect on confirmed auth errors, not network errors
            console.error('Auth check error:', error);
            // Don't auto-redirect on network errors - let user retry
        });
    });
    </script>
</body>
</html>
