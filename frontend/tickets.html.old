<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√© C·ªßa T√¥i - B·∫£o T√†ng B·∫øn Nh√† R·ªìng</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
            color: #c41e3a;
            text-decoration: none;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-back {
            padding: 0.5rem 1rem;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: #333;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: #e0e0e0;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Header */
        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            color: #c41e3a;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #666;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.7rem 1.5rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-btn.active {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }

        .filter-btn:hover {
            border-color: #c41e3a;
        }

        /* Tickets Grid */
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .ticket-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .ticket-card:hover {
            transform: translateY(-5px);
        }

        .ticket-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
        }

        .ticket-code {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .ticket-type {
            opacity: 0.9;
        }

        .ticket-body {
            padding: 1.5rem;
        }

        .ticket-info {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            color: #666;
            font-size: 0.9rem;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .ticket-status {
            display: inline-block;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-checked_in {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-checked_out {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .ticket-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.7rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #c41e3a;
            color: white;
        }

        .btn-primary:hover {
            background: #a01828;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #666;
            margin-bottom: 1.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .modal-body {
            padding: 2rem;
        }

        .qr-container {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            background: #f8f8f8;
            border-radius: 15px;
        }

        .qr-code {
            display: inline-block;
            padding: 1rem;
            background: white;
            border-radius: 10px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #c41e3a;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .tickets-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 0 1rem;
            }

            .filter-group {
                flex-direction: column;
            }

            .filter-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <a href="/" class="logo">B·∫£o T√†ng B·∫øn Nh√† R·ªìng</a>
        <div class="nav-user">
            <span id="userName"></span>
            <a href="/" class="btn-back">‚Üê V·ªÅ Trang Ch·ªß</a>
        </div>
    </nav>

    <!-- Container -->
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1>üé´ V√© C·ªßa T√¥i</h1>
            <p>Qu·∫£n l√Ω v√† xem chi ti·∫øt c√°c v√© ƒë√£ mua</p>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterTickets('all')">
                    T·∫•t C·∫£
                </button>
                <button class="filter-btn" onclick="filterTickets('active')">
                    Ho·∫°t ƒê·ªông
                </button>
                <button class="filter-btn" onclick="filterTickets('checked_in')">
                    ƒê√£ Check-in
                </button>
                <button class="filter-btn" onclick="filterTickets('checked_out')">
                    ƒê√£ Check-out
                </button>
                <button class="filter-btn" onclick="filterTickets('completed')">
                    Ho√†n Th√†nh
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i v√©...</p>
        </div>

        <!-- Tickets Grid -->
        <div class="tickets-grid" id="ticketsGrid" style="display: none;"></div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üé´</div>
            <h3>Ch∆∞a c√≥ v√© n√†o</h3>
            <p>B·∫°n ch∆∞a mua v√© n√†o. Li√™n h·ªá qu·∫ßy ƒë·ªÉ mua v√© tham quan.</p>
            <a href="/" class="btn btn-primary">V·ªÅ Trang Ch·ªß</a>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div class="modal" id="ticketModal">
        <div class="modal-content">
            <div class="modal-header" style="position: relative;">
                <button class="close-modal" onclick="closeModal()">√ó</button>
                <h2 id="modalTicketCode">MT2601154ACF</h2>
                <p id="modalTicketType">V√© Ng∆∞·ªùi L·ªõn</p>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div class="qr-code" id="qrCode"></div>
                    <p style="margin-top: 1rem; color: #666;">Xu·∫•t tr√¨nh m√£ QR n√†y khi check-in</p>
                </div>

                <div id="ticketDetails"></div>

                <button class="btn btn-primary" onclick="closeModal()" style="width: 100%; margin-top: 1rem;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let allTickets = [];
        let currentFilter = 'all';

        // Load tickets on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadTickets();
        });

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/session`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.success || !data.logged_in) {
                    window.location.href = '/login.html';
                    return;
                }

                document.getElementById('userName').textContent = data.data.fullname || data.data.username;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
            }
        }

        // Load tickets
        async function loadTickets() {
            try {
                const response = await fetch(`${API_URL}/customer/tickets?per_page=100`, {
                    credentials: 'include'
                });
                const data = await response.json();

                document.getElementById('loadingState').style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    allTickets = data.data;
                    displayTickets(allTickets);
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                }
            } catch (error) {
                console.error('Load tickets error:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // Display tickets
        function displayTickets(tickets) {
            const grid = document.getElementById('ticketsGrid');
            grid.innerHTML = '';
            grid.style.display = 'grid';
            document.getElementById('emptyState').style.display = 'none';

            if (tickets.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                grid.style.display = 'none';
                return;
            }

            tickets.forEach(ticket => {
                const card = createTicketCard(ticket);
                grid.appendChild(card);
            });
        }

        // Create ticket card
        function createTicketCard(ticket) {
            const card = document.createElement('div');
            card.className = 'ticket-card';
            card.onclick = () => showTicketDetail(ticket.ticket_id);

            const statusLabels = {
                'active': 'Ho·∫°t ƒê·ªông',
                'checked_in': 'ƒê√£ Check-in',
                'checked_out': 'ƒê√£ Check-out',
                'completed': 'Ho√†n Th√†nh'
            };

            card.innerHTML = `
                <div class="ticket-header">
                    <div class="ticket-code">${ticket.code}</div>
                    <div class="ticket-type">${ticket.ticket_type_name}</div>
                </div>
                <div class="ticket-body">
                    <div class="ticket-info">
                        <div class="info-row">
                            <span class="info-label">Tr·∫°ng th√°i:</span>
                            <span class="ticket-status status-${ticket.status}">
                                ${statusLabels[ticket.status] || ticket.status}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng√†y mua:</span>
                            <span class="info-value">${formatDate(ticket.purchase_date)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">S·ªë l∆∞·ª£ng:</span>
                            <span class="info-value">${ticket.quantity} v√©</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">T·ªïng ti·ªÅn:</span>
                            <span class="info-value">${formatPrice(ticket.total_price)}</span>
                        </div>
                    </div>
                    <div class="ticket-actions">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); showTicketDetail(${ticket.ticket_id})">
                            Xem QR Code
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // Filter tickets
        function filterTickets(status) {
            currentFilter = status;

            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter tickets
            let filtered = allTickets;
            if (status !== 'all') {
                filtered = allTickets.filter(t => t.status === status);
            }

            displayTickets(filtered);
        }

        // Show ticket detail modal
        async function showTicketDetail(ticketId) {
            try {
                const response = await fetch(`${API_URL}/customer/tickets/${ticketId}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    const ticket = data.data;
                    
                    document.getElementById('modalTicketCode').textContent = ticket.code;
                    document.getElementById('modalTicketType').textContent = ticket.ticket_type.name;

                    // Generate QR Code
                    document.getElementById('qrCode').innerHTML = '';
                    new QRCode(document.getElementById('qrCode'), {
                        text: ticket.qr_data || `TICKET-${ticket.code}`,
                        width: 200,
                        height: 200
                    });

                    // Display details
                    const statusLabels = {
                        'active': 'Ho·∫°t ƒê·ªông',
                        'checked_in': 'ƒê√£ Check-in',
                        'checked_out': 'ƒê√£ Check-out',
                        'completed': 'Ho√†n Th√†nh'
                    };

                    document.getElementById('ticketDetails').innerHTML = `
                        <div class="detail-row">
                            <strong>M√£ v√©:</strong>
                            <span>${ticket.code}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Lo·∫°i v√©:</strong>
                            <span>${ticket.ticket_type.name}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Tr·∫°ng th√°i:</strong>
                            <span class="ticket-status status-${ticket.status}">
                                ${statusLabels[ticket.status]}
                            </span>
                        </div>
                        <div class="detail-row">
                            <strong>S·ªë l∆∞·ª£ng:</strong>
                            <span>${ticket.quantity} v√©</span>
                        </div>
                        <div class="detail-row">
                            <strong>ƒê∆°n gi√°:</strong>
                            <span>${formatPrice(ticket.ticket_type.price)}</span>
                        </div>
                        <div class="detail-row">
                            <strong>T·ªïng ti·ªÅn:</strong>
                            <span>${formatPrice(ticket.total_price)}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Ng√†y mua:</strong>
                            <span>${formatDate(ticket.purchase_date)}</span>
                        </div>
                        ${ticket.visit.check_in_time ? `
                            <div class="detail-row">
                                <strong>Check-in:</strong>
                                <span>${formatDateTime(ticket.visit.check_in_time)}</span>
                            </div>
                        ` : ''}
                        ${ticket.visit.check_out_time ? `
                            <div class="detail-row">
                                <strong>Check-out:</strong>
                                <span>${formatDateTime(ticket.visit.check_out_time)}</span>
                            </div>
                        ` : ''}
                        ${ticket.visit.rating ? `
                            <div class="detail-row">
                                <strong>ƒê√°nh gi√°:</strong>
                                <span>${'‚≠ê'.repeat(ticket.visit.rating)}</span>
                            </div>
                        ` : ''}
                    `;

                    document.getElementById('ticketModal').classList.add('show');
                }
            } catch (error) {
                console.error('Show ticket detail error:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin v√©');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('ticketModal').classList.remove('show');
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        // Format datetime
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('vi-VN');
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        // Close modal on outside click
        document.getElementById('ticketModal').addEventListener('click', (e) => {
            if (e.target.id === 'ticketModal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
