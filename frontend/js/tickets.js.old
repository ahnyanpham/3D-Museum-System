// ==========================================
// TICKETS.JS - FIXED VERSION
// File chung cho ADMIN (bán vé) và USER (xem vé)
// ==========================================

// Define API_URL if not already defined
const API_URL = window.API_URL || '/api';

const TicketManager = {
    ticketTypes: [],
    currentCustomer: null,
    lastTicketData: null,
    isSubmitting: false,
    currentPage: 1,
    itemsPerPage: 10,
    totalTickets: 0,
    allTickets: [],
    isAdminMode: false, // Will be determined on init
    
    async init() {
        console.log('Ticket Manager initialized');
        
        // Determine mode based on page elements
        this.isAdminMode = document.getElementById('ticket-form') !== null;
        console.log('Mode:', this.isAdminMode ? 'ADMIN' : 'USER');
        
        if (this.isAdminMode) {
            // Admin mode: Load ticket types for selling
            await this.loadTicketTypes();
        }
        
        this.setupEventListeners();
        this.setDefaultDate();
        await this.loadRecentTickets();
    },
    
    setupEventListeners() {
        const reloadTicketsBtn = document.getElementById("reload-tickets");
        if (reloadTicketsBtn) {
            reloadTicketsBtn.addEventListener("click", () => this.loadRecentTickets());
        }
        
        // Admin-only elements
        if (this.isAdminMode) {
            const searchBtn = document.getElementById('search-customer');
            const ticketForm = document.getElementById('ticket-form');
            const quantityInput = document.getElementById('quantity');
            const ticketTypeSelect = document.getElementById('ticket-type');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', () => this.searchCustomer());
            }
            
            if (ticketForm) {
                ticketForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sellTicket();
                });
            }
            
            if (quantityInput && ticketTypeSelect) {
                quantityInput.addEventListener('input', () => this.calculateTotal());
                ticketTypeSelect.addEventListener('change', () => this.calculateTotal());
            }
        }
    },
    
    async loadTicketTypes() {
        try {
            const response = await fetch(`${API_URL}/booking/ticket-types`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success) {
                this.ticketTypes = data.data || [];
                this.populateTicketTypes();
            }
        } catch (error) {
            console.error('Error loading ticket types:', error);
        }
    },
    
    populateTicketTypes() {
        const select = document.getElementById('ticket-type');
        if (!select) return;
        
        select.innerHTML = '<option value="">-- Chọn loại vé --</option>';
        this.ticketTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = `${type.name} - ${formatCurrency(type.price)}`;
            option.dataset.price = type.price;
            select.appendChild(option);
        });
    },
    
    calculateTotal() {
        const select = document.getElementById('ticket-type');
        const quantityInput = document.getElementById('quantity');
        const totalPrice = document.getElementById('total-price');
        
        if (!select || !quantityInput || !totalPrice) return;
        
        const selectedOption = select.options[select.selectedIndex];
        const price = selectedOption ? parseInt(selectedOption.dataset.price || 0) : 0;
        const quantity = parseInt(quantityInput.value) || 0;
        const total = price * quantity;
        
        totalPrice.textContent = formatCurrency(total);
    },
    
    async searchCustomer() {
        const phoneInput = document.getElementById('phone-search');
        if (!phoneInput) return;
        
        const phone = phoneInput.value.trim();
        if (!phone) {
            showToast('Vui lòng nhập số điện thoại', 'warning');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch(`${API_URL}/customers/search?phone=${encodeURIComponent(phone)}`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            hideLoading();
            
            if (data.success && data.data) {
                this.currentCustomer = data.data;
                this.displayCustomerInfo();
            } else {
                throw new Error(data.message || 'Không tìm thấy khách hàng');
            }
        } catch (error) {
            hideLoading();
            showToast('Lỗi: ' + error.message, 'error');
            this.currentCustomer = null;
            this.clearCustomerInfo();
        }
    },
    
    displayCustomerInfo() {
        const container = document.getElementById('customer-info');
        if (!container || !this.currentCustomer) return;
        
        container.innerHTML = `
            <div style="padding:15px;background:#d4edda;border-radius:8px;border-left:4px solid #28a745">
                <h4 style="margin:0 0 10px 0;color:#155724">Thông tin khách hàng</h4>
                <p style="margin:5px 0"><strong>Họ tên:</strong> ${this.currentCustomer.fullname || 'N/A'}</p>
                <p style="margin:5px 0"><strong>SĐT:</strong> ${this.currentCustomer.phone || 'N/A'}</p>
                <p style="margin:5px 0"><strong>Email:</strong> ${this.currentCustomer.email || 'N/A'}</p>
            </div>
        `;
    },
    
    clearCustomerInfo() {
        const container = document.getElementById('customer-info');
        if (container) {
            container.innerHTML = '';
        }
    },
    
    async sellTicket() {
        if (this.isSubmitting) return;
        
        if (!this.currentCustomer) {
            showToast('Vui lòng tìm khách hàng trước', 'warning');
            return;
        }
        
        const form = document.getElementById('ticket-form');
        if (!form) return;
        
        const formData = new FormData(form);
        const ticketTypeId = formData.get('ticket-type');
        const quantity = parseInt(formData.get('quantity')) || 1;
        const visitDate = formData.get('visit-date');
        const paymentMethod = formData.get('payment-method');
        
        if (!ticketTypeId || !visitDate || !paymentMethod) {
            showToast('Vui lòng điền đầy đủ thông tin', 'warning');
            return;
        }
        
        this.isSubmitting = true;
        showLoading();
        
        try {
            const response = await fetch(`${API_URL}/tickets/sell`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    customer_id: this.currentCustomer.id,
                    ticket_type_id: parseInt(ticketTypeId),
                    quantity: quantity,
                    visit_date: visitDate,
                    payment_method: paymentMethod
                })
            });
            
            const data = await response.json();
            
            hideLoading();
            this.isSubmitting = false;
            
            if (data.success) {
                this.lastTicketData = data.data;
                showToast('Bán vé thành công!', 'success');
                
                // Show QR or Banking QR based on payment method
                if (paymentMethod === 'cash') {
                    this.showTicketQR();
                } else {
                    this.showBankingQR();
                }
                
                this.resetForm();
                await this.loadRecentTickets();
            } else {
                throw new Error(data.message || 'Lỗi bán vé');
            }
        } catch (error) {
            hideLoading();
            this.isSubmitting = false;
            console.error('Error selling ticket:', error);
            showToast('Lỗi bán vé: ' + (error.message || 'Vui lòng thử lại'), 'error');
        }
    },
    
    showTicketQR() {
        const modal = document.getElementById('ticket-modal');
        const detailsDiv = document.getElementById('ticket-details');
        
        if (!modal || !detailsDiv || !this.lastTicketData) return;
        
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(this.lastTicketData.ticketCode)}`;
        
        detailsDiv.innerHTML = `
            <div style="padding:20px;text-align:center">
                <div style="background:#28a745;color:white;padding:15px;border-radius:8px 8px 0 0;margin:-20px -20px 20px -20px">
                    <h3 style="margin:0">✓ Vé Bán Thành Công!</h3>
                </div>
                <p><strong>Mã vé:</strong> ${this.lastTicketData.ticketCode}</p>
                <p><strong>Khách hàng:</strong> ${this.lastTicketData.customerName}</p>
                <div style="margin:20px 0">
                    <img src="${qrCodeUrl}" 
                         style="max-width:300px;border:4px solid #667eea;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)" 
                         crossorigin="anonymous">
                </div>
                <p style="color:#666;font-size:14px">
                    <i class="fas fa-info-circle"></i> 
                    Quét QR Code này để check-in tại cổng vào
                </p>
                <button id="download-qr" class="btn btn-primary" style="margin:10px 5px">
                    <i class="fas fa-download"></i> Tải Vé
                </button>
                <button class="btn btn-secondary close" style="margin:10px 5px">Đóng</button>
            </div>
        `;
        
        modal.classList.add('active');
        
        setTimeout(() => {
            const downloadBtn = document.getElementById('download-qr');
            if (downloadBtn) {
                downloadBtn.onclick = () => this.downloadQR(qrCodeUrl, this.lastTicketData.ticketCode);
            }
            
            const closeBtn = modal.querySelector('.close');
            if (closeBtn) {
                closeBtn.onclick = () => modal.classList.remove('active');
            }
        }, 100);
    },
    
    showBankingQR() {
        const modal = document.getElementById('ticket-modal');
        const detailsDiv = document.getElementById('ticket-details');
        
        if (!modal || !detailsDiv || !this.lastTicketData) return;
        
        const vietqrUrl = 'https://img.vietqr.io/image/970416-0188123987-compact2.png?amount=' + this.lastTicketData.totalPrice + '&addInfo=' + this.lastTicketData.ticketCode + '&accountName=Nhom%2011%20UIT';
        
        detailsDiv.innerHTML = `
            <div style="padding:20px;text-align:center">
                <h3 style="color:#667eea;margin-bottom:15px">Chuyển Khoản Thanh Toán</h3>
                <p><strong>Mã vé:</strong> ${this.lastTicketData.ticketCode}</p>
                <p><strong>Khách hàng:</strong> ${this.lastTicketData.customerName}</p>
                <p><strong>Tổng tiền:</strong> ${formatCurrency(this.lastTicketData.totalPrice)}</p>
                <div style="margin:20px 0">
                    <img src="${vietqrUrl}" 
                         style="max-width:300px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15)" 
                         crossorigin="anonymous">
                </div>
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;text-align:left;margin:20px 0">
                    <p><strong>Ngân hàng:</strong> ACB</p>
                    <p><strong>Số tài khoản:</strong> 0188123987</p>
                    <p><strong>Chủ tài khoản:</strong> Nhóm 11 UIT</p>
                    <p><strong>Nội dung:</strong> ${this.lastTicketData.ticketCode}</p>
                </div>
                <button id="confirm-payment" class="btn btn-primary">Xác nhận đã chuyển khoản</button>
            </div>
        `;
        
        modal.classList.add('active');
        
        setTimeout(() => {
            const confirmBtn = document.getElementById('confirm-payment');
            if (confirmBtn) {
                confirmBtn.onclick = async () => {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'Đang gửi email...';
                    
                    try {
                        const response = await fetch(`${API_URL}/tickets/${this.lastTicketData.ticketId}/send-email`, { 
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({})
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showToast(data.message || 'Đã gửi email thành công!', 'success');
                            modal.classList.remove('active');
                            
                            // ✅ Show ticket QR after email sent
                            setTimeout(() => {
                                this.showTicketQR();
                            }, 300);
                            
                            await this.loadRecentTickets();
                        } else {
                            throw new Error(data.message || 'Lỗi gửi email');
                        }
                    } catch (error) {
                        console.error('Email error:', error);
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Xác nhận đã chuyển khoản';
                        showToast('Lỗi gửi email: ' + (error.message || 'Vui lòng thử lại'), 'error');
                    }
                };
            }
            
            const closeBtn = modal.querySelector('.close');
            if (closeBtn) {
                closeBtn.onclick = () => modal.classList.remove('active');
            }
        }, 100);
    },
    
    downloadQR(qrUrl, ticketCode) {
        const link = document.createElement('a');
        link.href = qrUrl.replace('300x300', '800x800');
        link.download = `ve_${ticketCode}.png`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },
    
    async loadRecentTickets() {
        try {
            let response;
            
            if (this.isAdminMode) {
                // ✅ ADMIN: Load all tickets
                response = await fetch(`${API_URL}/tickets?limit=100`, {
                    credentials: 'include'
                });
            } else {
                // ✅ USER: Load customer's own tickets
                response = await fetch(`${API_URL}/customer/tickets`, {
                    credentials: 'include'
                });
            }
            
            const data = await response.json();
            
            if (data.success) {
                this.allTickets = data.data || [];
                this.totalTickets = this.allTickets.length;
                console.log('Loaded tickets:', this.totalTickets);
                this.renderTickets();
            }
        } catch (error) {
            console.error('Error loading tickets:', error);
            showToast('Lỗi tải danh sách vé: ' + error.message, 'error');
        }
    },
    
    renderTickets() {
        const container = document.getElementById('recent-tickets');
        if (!container) return;
        
        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        const pageTickets = this.allTickets.slice(start, end);
        
        if (pageTickets.length === 0) {
            container.innerHTML = '<p style="text-align:center;padding:40px;color:#999">Chưa có vé nào</p>';
            return;
        }
        
        let html = '<div class="data-table-container"><table class="data-table"><thead><tr>';
        html += '<th>Mã vé</th><th>Khách hàng</th><th>Loại vé</th><th>SL</th><th>Tổng tiền</th><th>Ngày</th><th>Trạng thái</th><th>Thao tác</th>';
        html += '</tr></thead><tbody>';
        
        pageTickets.forEach(ticket => {
            const statusClass = ticket.status === 'valid' ? 'active' : 'cancelled';
            const statusText = ticket.status === 'valid' ? 'Còn hạn' : (ticket.status === 'used' ? 'Đã dùng' : 'Đã hủy');
            
            html += '<tr>';
            html += '<td><strong>' + (ticket.ticket_code || ticket.code || 'N/A') + '</strong></td>';
            html += '<td>' + (ticket.customer_name || ticket.full_name || 'N/A') + '</td>';
            html += '<td>' + (ticket.ticket_type_name || ticket.type_name || 'N/A') + '</td>';
            html += '<td>' + (ticket.quantity || 0) + '</td>';
            html += '<td>' + formatCurrency(ticket.total_price || ticket.price * ticket.quantity || 0) + '</td>';
            html += '<td>' + formatDate(ticket.valid_date || ticket.purchase_date) + '</td>';
            html += '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>';
            
            // Action buttons
            if (ticket.status === 'valid') {
                html += '<td>';
                html += '<button onclick="TicketManager.viewTicketQR(\'' + (ticket.ticket_code || ticket.code) + '\')" class="btn btn-sm btn-primary" style="margin-right:5px">Xem QR</button>';
                if (this.isAdminMode) {
                    html += '<button onclick="TicketManager.cancelTicket(' + (ticket.ticket_id || ticket.id) + ', \'' + (ticket.ticket_code || ticket.code) + '\')" class="btn btn-sm" style="background:#dc3545;color:white">Hủy vé</button>';
                }
                html += '</td>';
            } else {
                html += '<td>-</td>';
            }
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
        this.renderPagination();
    },
    
    viewTicketQR(ticketCode) {
        const modal = document.getElementById('ticket-modal');
        const detailsDiv = document.getElementById('ticket-details');
        
        if (!modal || !detailsDiv) return;
        
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(ticketCode)}`;
        
        detailsDiv.innerHTML = `
            <div style="padding:20px;text-align:center">
                <h3 style="color:#2d3748;margin-bottom:20px">Mã QR Vé</h3>
                <div style="background:#f7fafc;padding:20px;border-radius:12px;display:inline-block">
                    <img src="${qrCodeUrl}" 
                         style="max-width:300px;border-radius:8px" 
                         crossorigin="anonymous">
                </div>
                <p style="margin:20px 0;font-weight:600;font-family:monospace;font-size:18px">${ticketCode}</p>
                <p style="color:#718096;margin-bottom:20px">
                    <i class="fas fa-info-circle"></i> 
                    Xuất trình QR này khi check-in
                </p>
                <div style="display:flex;gap:10px;justify-content:center">
                    <button onclick="TicketManager.downloadTicketQR('${qrCodeUrl}', '${ticketCode}')" 
                            class="btn btn-primary">
                        <i class="fas fa-download"></i> Tải về
                    </button>
                    <button class="btn btn-secondary close">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                </div>
            </div>
        `;
        
        modal.classList.add('active');
        
        setTimeout(() => {
            const closeBtn = modal.querySelector('.close');
            if (closeBtn) {
                closeBtn.onclick = () => modal.classList.remove('active');
            }
        }, 100);
    },
    
    downloadTicketQR(qrUrl, ticketCode) {
        const link = document.createElement('a');
        link.href = qrUrl.replace('300x300', '800x800');
        link.download = `ve_${ticketCode}.png`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Đang tải QR code...', 'success');
    },
    
    async cancelTicket(ticketId, ticketCode) {
        if (!confirm('Bạn có chắc muốn hủy vé ' + ticketCode + '?\n\nLưu ý: Thao tác này không thể hoàn tác!')) {
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch(`${API_URL}/tickets/${ticketId}/cancel`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            hideLoading();
            
            if (data.success) {
                showToast('Đã hủy vé thành công!', 'success');
                await this.loadRecentTickets();
            } else {
                throw new Error(data.message || 'Lỗi hủy vé');
            }
        } catch (error) {
            hideLoading();
            showToast('Lỗi hủy vé: ' + (error.message || 'Vui lòng thử lại'), 'error');
            console.error('Cancel ticket error:', error);
        }
    },
    
    renderPagination() {
        const container = document.getElementById('tickets-pagination');
        if (!container) return;
        
        const totalPages = Math.ceil(this.totalTickets / this.itemsPerPage);
        
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<div style="display:flex;gap:5px;justify-content:center">';
        
        if (this.currentPage > 1) {
            html += '<button onclick="TicketManager.goToPage(' + (this.currentPage - 1) + ')" class="btn btn-sm">Trước</button>';
        }
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                const activeClass = i === this.currentPage ? 'btn-primary' : 'btn-secondary';
                html += '<button onclick="TicketManager.goToPage(' + i + ')" class="btn btn-sm ' + activeClass + '">' + i + '</button>';
            }
        }
        
        if (this.currentPage < totalPages) {
            html += '<button onclick="TicketManager.goToPage(' + (this.currentPage + 1) + ')" class="btn btn-sm">Sau</button>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    },
    
    goToPage(page) {
        this.currentPage = page;
        this.renderTickets();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    },
    
    setDefaultDate() {
        const dateInput = document.getElementById('visit-date');
        if (!dateInput) return;
        
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        dateInput.value = dateStr;
        dateInput.min = dateStr;
    },
    
    resetForm() {
        const form = document.getElementById('ticket-form');
        const customerInfo = document.getElementById('customer-info');
        const totalPrice = document.getElementById('total-price');
        
        if (form) form.reset();
        if (customerInfo) customerInfo.innerHTML = '';
        if (totalPrice) totalPrice.textContent = '0 đ';
        
        this.currentCustomer = null;
        this.setDefaultDate();
    }
};

console.log('Tickets module loaded');
