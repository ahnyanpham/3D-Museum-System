-- ========================================
-- CREATE USER_SESSION TABLE
-- Track user login/logout accurately
-- ========================================

CREATE TABLE IF NOT EXISTS USER_SESSION (
    SESSION_ID INTEGER PRIMARY KEY AUTOINCREMENT,
    USER_ID INTEGER NOT NULL,
    SESSION_TOKEN TEXT UNIQUE NOT NULL,
    LOGIN_TIME TEXT DEFAULT CURRENT_TIMESTAMP,
    LOGOUT_TIME TEXT,
    LAST_ACTIVITY TEXT DEFAULT CURRENT_TIMESTAMP,
    IP_ADDRESS TEXT,
    USER_AGENT TEXT,
    IS_ACTIVE INTEGER DEFAULT 1,
    CREATED_AT TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES USER(USER_ID)
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_session_user ON USER_SESSION(USER_ID);
CREATE INDEX IF NOT EXISTS idx_session_token ON USER_SESSION(SESSION_TOKEN);
CREATE INDEX IF NOT EXISTS idx_session_active ON USER_SESSION(IS_ACTIVE);
CREATE INDEX IF NOT EXISTS idx_session_last_activity ON USER_SESSION(LAST_ACTIVITY);

-- Trigger: Auto update LAST_ACTIVITY
CREATE TRIGGER IF NOT EXISTS update_session_activity
AFTER UPDATE ON USER_SESSION
FOR EACH ROW
WHEN NEW.IS_ACTIVE = 1 AND OLD.LAST_ACTIVITY = NEW.LAST_ACTIVITY
BEGIN
    UPDATE USER_SESSION
    SET LAST_ACTIVITY = CURRENT_TIMESTAMP
    WHERE SESSION_ID = NEW.SESSION_ID;
END;

-- View: Active sessions
CREATE VIEW IF NOT EXISTS v_active_sessions AS
SELECT 
    s.SESSION_ID,
    s.USER_ID,
    u.USERNAME,
    u.FULLNAME,
    s.LOGIN_TIME,
    s.LAST_ACTIVITY,
    s.IP_ADDRESS,
    CASE 
        WHEN datetime(s.LAST_ACTIVITY) > datetime('now', '-30 minutes')
        THEN 'ONLINE'
        ELSE 'IDLE'
    END as STATUS
FROM USER_SESSION s
JOIN USER u ON s.USER_ID = u.USER_ID
WHERE s.IS_ACTIVE = 1
ORDER BY s.LAST_ACTIVITY DESC;
